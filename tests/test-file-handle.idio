;;
;; Copyright (c) 2015, 2020 Ian Fitchet <idf(at)idio-lang.org>
;;
;; Licensed under the Apache License, Version 2.0 (the "License"); you
;; may not use this file except in compliance with the License.  You
;; may obtain a copy of the License at
;;
;;     http://www.apache.org/licenses/LICENSE-2.0
;;
;; Unless required by applicable law or agreed to in writing, software
;; distributed under the License is distributed on an "AS IS" BASIS,
;; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
;; See the License for the specific language governing permissions and
;; limitations under the License.
;;
;;

;;
;; test-file-handle.idio
;;
file-handle0 := Tests

test-str := "foo"
test (file-handle? test-str) #f
test (input-file-handle? test-str) #f
test (output-file-handle? test-str) #f

ofh := open-output-file testfile
test (file-handle? ofh) #t
test (output-file-handle? ofh) #t
test (input-file-handle? ofh) #f

fho := "Hello"
write fho ofh
close-handle ofh

test (file-handle? ofh) #t
test (output-file-handle? ofh) #t
test (input-file-handle? ofh) #f

ifh := open-input-file testfile
test (file-handle? ifh) #t
test (input-file-handle? ifh) #t
test (output-file-handle? ifh) #f

fhi := *primitives*/read ifh
close-handle ifh

test (file-handle? ifh) #t
test (input-file-handle? ifh) #t
test (output-file-handle? ifh) #f

test fhi fho

;; use the text read in again
ifh := open-input-file testfile
test (file-handle? ifh) #t
test (input-file-handle? ifh) #t
test (output-file-handle? ifh) #f

;; seek to the third character of "Hello" , #\e
ifn := seek-handle ifh 2
test ifn 2

fhi := read-char ifh

test fhi #\e
test (peek-char ifh) #\l

; default is SEEK_SET
seek-handle ifh 2
test (peek-char ifh) #\e

seek-handle ifh -2 'cur
test (peek-char ifh) #\"

seek-handle ifh 2 'set
test (peek-char ifh) #\e

seek-handle ifh -2 'end
test (peek-char ifh) #\o

rewind-handle ifh
test (peek-char ifh) #\"

test (handle-pos ifh) 0
seek-handle ifh 2
test (handle-pos ifh) 2

;; GC and file handles

;; Keep opening a file until we've used up all (per-process) file
;; descriptors -- we retain the handles in an array.

;; Outside of this block the array is no longer in scope and the
;; attempt to open another file should trigger a GC and we're good to
;; go again.
{
  fds := #[ ]
  loop-k := #n
  trap ^system-error (function (c) {
			test (C/== (system-error-errno c) (C/integer-> 24)) #t
			if (C/== (system-error-errno c) (C/integer-> 24)) {
                          printf "test file-handle trap: created %d\n" (array-length fds)
                        } {
                          condition-report "test file-handle trap" c (current-error-handle)
                        }
			loop-k 'too-many-open-files
  }) {
    call/cc (function (k) {
	       loop-k = k
	       loop :+ function () {
			 ish := open-input-file testfile
			 fds =+ ish
			 (loop)
	       }

	       (loop)
    })
  }
}

;; fds is now out of scope and should be collectable thus freeing up
;; all those file descriptors
ifh := open-input-file testfile
test (input-file-handle? ifh) #t

; code coverage
ifh = open-file testfile "r+"
test (input-file-handle? ifh) #t
test (output-file-handle? ifh) #t
test (ready? ifh) #t
close-handle ifh
test (ready? ifh) #f

ofh = open-file testfile "w+"
test (output-file-handle? ofh) #t
test (input-file-handle? ofh) #t
test (ready? ofh) #t
close-handle ofh
test (ready? ofh) #f

ofh = open-file testfile "a+"
test (output-file-handle? ofh) #t
test (input-file-handle? ofh) #t
test (ready? ofh) #t
close-handle ofh
test (ready? ofh) #f

;; ready? code coverage!
ofh = open-file testfile "w"
write "hello\n" ofh
close-handle ofh

ifh = open-file testfile "r"
read-char ifh
;; different code path!
test (ready? ifh) #t
close-handle ifh

;; all done?
Tests? (file-handle0 + 44)
