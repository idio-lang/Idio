;;
;; Copyright (c) 2015 Ian Fitchet <idf(at)idio-lang.org>
;;
;; Licensed under the Apache License, Version 2.0 (the "License"); you
;; may not use this file except in compliance with the License.  You
;; may obtain a copy of the License at
;;
;;     http://www.apache.org/licenses/LICENSE-2.0
;;
;; Unless required by applicable law or agreed to in writing, software
;; distributed under the License is distributed on an "AS IS" BASIS,
;; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
;; See the License for the specific language governing permissions and
;; limitations under the License.
;;
;;

;;
;; command.idio
;;

;; How to test external commands?

;; side-effects?

;; tinker with the PATH
OPATH := PATH
PATH = string-append PATH ":" PWD 

monitor (function (cont cond) {
  ;; edisplay* "auto-exit: monitor" cont cond
  test (rt-command-status-error? cond) #t
  if cont {
    if (rt-command-status-error? cond) {
      edisplay* "auto-exit: unexpected status error" cond

      'job-failed
    } {
      edisplay* "auto-exit: unexpected condition" cond
      raise cont cond
    }
  } {
    edisplay* "auto-exit: unexpected non-continuable condition" cond
    raise cont cond
  }
}) {
  test (auto-exit) #t
}

monitor (function (cont cond) {
  ;; edisplay* "auto-exit -e 11: monitor" cont cond
  test (rt-command-status-error? cond) #t
  if cont {
    if (rt-command-status-error? cond) {
      job := idio-error-location cond
      test (job-detail job) '(exit 11)

      ;; return the original status
      rt-command-status-error-status cond
    } {
      edisplay* "auto-exit -e 11: unexpected condition" cond
      raise cont cond
    }
  } {
    edisplay* "auto-exit -e 11: unexpected non-continuable condition" cond
    raise cont cond
  }
}) {
  test (auto-exit -e 11) #f
}

monitor (function (cont cond) {
  ;; edisplay* "auto-exit -k 15: monitor" cont cond
  test (rt-command-status-error? cond) #t
  if cont {
    if (rt-command-status-error? cond) {
      job := idio-error-location cond
      test (job-detail job) '(killed 15)

      ;; return the original status
      rt-command-status-error-status cond
    } {
      edisplay* "auto-exit -k 15: unexpected condition" cond
      raise cont cond
    }
  } {
    edisplay* "auto-exit -k 15: unexpected non-continuable condition" cond
    raise cont cond
  }
}) {
  test (auto-exit -k 15) #f
}



PATH = OPATH
